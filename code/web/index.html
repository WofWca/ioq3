<!DOCTYPE html><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>The Longest Yard</title>
<style>
html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: rgb(0, 0, 0); display:flex; align-items: center; justify-content: center; }
canvas { max-width: 100%; max-height: 100%; min-width: 100%; min-height: 100%; object-fit: contain; }
</style>

<canvas id=canvas></canvas>

<script type=module>

let { promise: demoq3pak0Promise, resolve: gotDemoq3pak0 } = Promise.withResolvers();
let { promise: demoq3pak1Promise, resolve: gotDemoq3pak1 } = Promise.withResolvers();
let { promise: demoq3ztm_flexible_hud_r8_baseq3Promise, resolve: gotDemoq3ztm_flexible_hud_r8_baseq3 } = Promise.withResolvers();

import('./ioquake3.wasm32.js').then((ioquake3)=>{
    ioquake3.default({
        canvas: canvas,
        arguments: generatedArguments.trim().split(/\s+/),
        preRun: [async (module) => {
            // Add the fetched asset files to the Emscripten virtual filesystem.
            module.addRunDependency('setup-ioq3-filesystem');
            module.FS.mkdirTree('/home/web_user/.q3a/demoq3');
            module.FS.writeFile('/home/web_user/.q3a/demoq3/pak0.pk3', await demoq3pak0Promise);
            module.FS.writeFile('/home/web_user/.q3a/demoq3/pak1.pk3', await demoq3pak1Promise);
            module.FS.writeFile('/home/web_user/.q3a/demoq3/ztm-flexible-hud-r8-baseq3.pk3', await demoq3ztm_flexible_hud_r8_baseq3Promise);
            module.removeRunDependency('setup-ioq3-filesystem');
        }],
    });
});

// First set up the command line arguments and the Emscripten filesystem.
let generatedArguments = `
    +set fs_game demoq3
    +set net_enabled 0
    +set r_mode -2
    +set cg_fovGunAdjust 1
    +set cg_fovAspectAdjust 1
    +map q3dm17
    +addbot daemia 4
    +addbotvisor 4
    +addbot sarge 4
    +addbot stripe 4
    +addbot major 4
`;

// pak1.pk3 is GPL, built from ioquake sources.
// ztm-flexible-hud-r8-baseq3.pk3 is a mod, obtained from https://clover.moe/flexible-hud-for-ioq3/
fetch('pak1.pk3').then(async r => gotDemoq3pak1(new Uint8Array(await r.arrayBuffer())));
fetch('ztm-flexible-hud-r8-baseq3.pk3').then(async r => gotDemoq3ztm_flexible_hud_r8_baseq3(new Uint8Array(await r.arrayBuffer())));
// demoq3/pak0.pk3 is original Quake 3 demo assets. Fetch them from a tarfile in a gz file in a shell script in a zip file at the Internet Archive.
// First check to see if we have it in the cache
const cache = await caches.open('thelongestyard');
const cacheResponse = await cache.match('/demoq3/pak0.pk3');
let demoq3pak0 = await cacheResponse?.arrayBuffer();
if (demoq3pak0) {
    demoq3pak0 = new Uint8Array(demoq3pak0);
} else {
    let sh = await fetch('https://archive.org/download/tucows_286139_Quake_III_Arena/linuxq3ademo-1.11-6.x86.gz.zip/linuxq3ademo-1.11-6.x86.gz.sh', { integrity: 'sha256-ZN7j9ptueS0dpP4KyY/tx+seN+oQJ/tgmp+t0GFQpOw=' }).then(r => r.body);
    // Skip the first 0x155C bytes of the shell script to get the gz file. Ugh, the streams API is terrible.
    let skipped = 0;
    let gz = sh.pipeThrough(new TransformStream({
        transform(chunk, controller) {
            const skip = 0x155C;
            if (skipped >= skip) {
                controller.enqueue(chunk);
                return;
            }
            const chunkStart = skipped;
            const chunkEnd = skipped + chunk.byteLength;
            skipped = chunkEnd;
            if (chunkEnd < skip) return;
            controller.enqueue(chunk.subarray(skip - chunkStart));
        }
    }));
    let tar = new Uint8Array(await new Response(gz.pipeThrough(new DecompressionStream('gzip'))).arrayBuffer());
    // the tar format is structured in 512 byte blocks. Read the blocks and find the pak0.pk3 file
    for (let offset = 0; offset < tar.byteLength;) {
        let name = String.fromCharCode.apply(null, tar.subarray(offset, offset + 100)).replace(/\0/g, '').trim();
        let size = parseInt(String.fromCharCode.apply(null, tar.subarray(offset + 124, offset + 136)).replace(/\0/g, '').trim(), 8);
        if (name === 'demoq3/pak0.pk3') {
            demoq3pak0 = tar.subarray(offset + 512, offset + 512 + size);
            cache.put('/demoq3/pak0.pk3', new Response(demoq3pak0, { headers: { 'Content-Type': 'application/octet-stream' } }));
            break;
        }
        offset += 512 + Math.ceil(size / 512) * 512;
    }
}
if (!demoq3pak0) throw new Error('demoq3/pak0.pk3 not found');
gotDemoq3pak0(demoq3pak0);

</script>
